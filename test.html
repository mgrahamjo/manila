<script>

var context = {
        title: '<span attr="test">hi \'ol boy</span>',
        items: [1, 2, 3, 4, 5],
        obj: {
            a: 1,
            b: 2,
            c: 3
        },
        flag: false
    },
	escapeMap = {
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        '\'': '&apos;'
    };

function htmlEscape(str) {
    return str.replace(/[&<>'"]/g, c => {
        return escapeMap[c];
    });
}

context._e_ = function(val) {
    return typeof val === 'string' ? htmlEscape(val) : val;
};

var template = `<h1><< title >></h1>
<h3><<<title>>></h3>
<h4>&lcub;&lcub;title&rcub;&rcub;</h4>
<<test>>
<<if (!flag) { >>
<ul>
<<items.forEach(function(item) { >>
    <<if (item) { >>
    <li><<item>><i>
        <<for (key in obj) { >>
            <<key>>:<<obj[key]>>
        << } >>
    </i></li>
    << } >>
<< }); >>
</ul>
<< } >>

<<if (flag) { >>
    flag is true
<<} else {>>
    flag is false
<< } >>`;

function tmpl(template) {

    return new Function('context',

        "var p=[];with(context){p.push(`" +
        
        template
            .replace(/`/g, "\\`")
            .replace(/<<<(?!\s*}.*?>>>)(?!.*{\s*>>>)(.*?)>>>/g, "`,(typeof $1==='undefined'?'':$1),`")
            .replace(/<<<\s*(.*?)\s*>>>/g, "`);$1\np.push(`")
            .replace(/<<(?!\s*}.*?>>)(?!.*{\s*>>)(.*?)>>/g, "`,(typeof $1==='undefined'?'':_e_($1)),`")
            .replace(/<<\s*(.*?)\s*>>/g, "`);$1\np.push(`")

      + "`);}return p.join('');");

}

</script>
